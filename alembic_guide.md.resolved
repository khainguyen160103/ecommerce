# ğŸ“˜ HÆ°á»›ng dáº«n sá»­ dá»¥ng Alembic - Tá»«ng bÆ°á»›c

## BÆ°á»›c 1: CÃ i Ä‘áº·t Alembic

```bash
pip install alembic
```

Kiá»ƒm tra Ä‘Ã£ cÃ i thÃ nh cÃ´ng:
```bash
alembic --version
```

---

## BÆ°á»›c 2: Khá»Ÿi táº¡o Alembic

Trong thÆ° má»¥c project cá»§a báº¡n:
```bash
cd d:\Freelancer\E-commerce\ECOMMERCE-BE-fast
alembic init alembic
```

**Káº¿t quáº£:** Táº¡o ra cáº¥u trÃºc:
```
ECOMMERCE-BE-fast/
â”œâ”€â”€ alembic/
â”‚   â”œâ”€â”€ versions/          # Chá»©a migration files
â”‚   â”œâ”€â”€ env.py            # âœ… Báº¡n Ä‘Ã£ táº¡o rá»“i
â”‚   â””â”€â”€ script.py.mako    # Template
â”œâ”€â”€ alembic.ini           # âœ… Báº¡n Ä‘Ã£ táº¡o rá»“i
```

---

## BÆ°á»›c 3: Kiá»ƒm tra cáº¥u hÃ¬nh

### âœ… File [alembic.ini](file:///d:/Freelancer/E-commerce/ECOMMERCE-BE-fast/alembic.ini) (dÃ²ng 87):
```ini
sqlalchemy.url = mysql+pymysql://root:162003@localhost:3306/ecommerce
```

### âœ… File [alembic/env.py](file:///d:/Freelancer/E-commerce/ECOMMERCE-BE-fast/alembic/env.py) (dÃ²ng 8-10):
```python
from sqlmodel import SQLModel
from app.models.role_model import Role
from app.models.user_model import User
```

### âœ… File [alembic/env.py](file:///d:/Freelancer/E-commerce/ECOMMERCE-BE-fast/alembic/env.py) (dÃ²ng 24):
```python
target_metadata = SQLModel.metadata
```

**Báº¡n Ä‘Ã£ cáº¥u hÃ¬nh Ä‘Ãºng rá»“i!** âœ…

---

## BÆ°á»›c 4: Táº¡o migration Ä‘áº§u tiÃªn

Cháº¡y lá»‡nh Ä‘á»ƒ Alembic tá»± Ä‘á»™ng phÃ¡t hiá»‡n models:

```bash
alembic revision --autogenerate -m "Initial migration with user and role tables"
```

**Alembic sáº½:**
1. So sÃ¡nh models Python vá»›i database hiá»‡n táº¡i
2. Táº¡o file migration trong `alembic/versions/`
3. File cÃ³ tÃªn dáº¡ng: `xxxx_initial_migration_with_user_and_role_tables.py`

---

## BÆ°á»›c 5: Xem migration file

Má»Ÿ file vá»«a táº¡o trong `alembic/versions/`, báº¡n sáº½ tháº¥y:

```python
def upgrade() -> None:
    # Táº¡o tables
    op.create_table('role',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('description', sa.String(), nullable=False),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_table('user',
        sa.Column('id', sa.String(), nullable=False),
        sa.Column('name', sa.String(), nullable=False),
        # ... cÃ¡c columns khÃ¡c
    )

def downgrade() -> None:
    # XÃ³a tables (rollback)
    op.drop_table('user')
    op.drop_table('role')
```

**Review migration nÃ y Ä‘á»ƒ Ä‘áº£m báº£o Ä‘Ãºng!**

---

## BÆ°á»›c 6: Cháº¡y migration

Apply migration lÃªn database:

```bash
alembic upgrade head
```

**Káº¿t quáº£:**
```
INFO  [alembic.runtime.migration] Running upgrade -> xxxx, Initial migration
```

Kiá»ƒm tra database, báº¡n sáº½ tháº¥y:
- âœ… Báº£ng `role` Ä‘Ã£ Ä‘Æ°á»£c táº¡o
- âœ… Báº£ng [user](file:///d:/Freelancer/E-commerce/ECOMMERCE-BE-fast/app/services/user_services.py#33-35) Ä‘Ã£ Ä‘Æ°á»£c táº¡o
- âœ… Báº£ng `alembic_version` (track migrations)

---

## BÆ°á»›c 7: Xem lá»‹ch sá»­ migrations

```bash
# Xem táº¥t cáº£ migrations
alembic history

# Xem migration hiá»‡n táº¡i
alembic current
```

---

## ğŸ”„ Workflow khi thay Ä‘á»•i models

### VÃ­ dá»¥: ThÃªm field `phone` vÃ o User

**1. Sá»­a model:**
```python
# app/models/user_model.py
class User(UserBase, table=True):
    # ... cÃ¡c fields cÅ©
    phone: str | None = None  # â† Field má»›i
```

**2. Táº¡o migration:**
```bash
alembic revision --autogenerate -m "Add phone field to user"
```

**3. Review migration file:**
```python
def upgrade():
    op.add_column('user', sa.Column('phone', sa.String(), nullable=True))

def downgrade():
    op.drop_column('user', 'phone')
```

**4. Apply migration:**
```bash
alembic upgrade head
```

---

## ğŸ“‹ CÃ¡c lá»‡nh Alembic thÆ°á»ng dÃ¹ng

| Lá»‡nh | MÃ´ táº£ |
|------|-------|
| `alembic revision --autogenerate -m "message"` | Táº¡o migration tá»± Ä‘á»™ng |
| `alembic upgrade head` | Upgrade lÃªn version má»›i nháº¥t |
| `alembic upgrade +1` | Upgrade 1 version |
| `alembic downgrade -1` | Downgrade 1 version |
| `alembic downgrade base` | Downgrade vá» Ä‘áº§u (xÃ³a háº¿t) |
| `alembic current` | Xem version hiá»‡n táº¡i |
| `alembic history` | Xem lá»‹ch sá»­ migrations |
| `alembic history --verbose` | Xem chi tiáº¿t |

---

## âš ï¸ LÆ°u Ã½ quan trá»ng

### âŒ KhÃ´ng lÃ m:
- XÃ³a migration files Ä‘Ã£ apply
- Sá»­a migration files Ä‘Ã£ apply
- Cháº¡y migrations trá»±c tiáº¿p trÃªn production mÃ  khÃ´ng test

### âœ… NÃªn lÃ m:
- LuÃ´n review migration files trÆ°á»›c khi apply
- Backup database trÆ°á»›c khi migrate production
- Commit migration files vÃ o Git
- Test migrations trÃªn local/staging trÆ°á»›c

---

## ğŸ§ª Test Alembic

### Test 1: Upgrade
```bash
alembic upgrade head
```

### Test 2: Downgrade
```bash
alembic downgrade -1
```

### Test 3: Upgrade láº¡i
```bash
alembic upgrade head
```

Náº¿u cáº£ 3 test Ä‘á»u OK â†’ Alembic Ä‘Ã£ setup Ä‘Ãºng! âœ…

---

## ğŸ”§ Troubleshooting

### Lá»—i: "Can't locate revision identified by 'xxxx'"
**Giáº£i phÃ¡p:** XÃ³a báº£ng `alembic_version` vÃ  cháº¡y láº¡i `alembic upgrade head`

### Lá»—i: "Target database is not up to date"
**Giáº£i phÃ¡p:** Cháº¡y `alembic upgrade head`

### Lá»—i: Import models khÃ´ng Ä‘Æ°á»£c
**Giáº£i phÃ¡p:** Kiá»ƒm tra [alembic.ini](file:///d:/Freelancer/E-commerce/ECOMMERCE-BE-fast/alembic.ini) cÃ³ `prepend_sys_path = .`

---

## âœ… Checklist hoÃ n thÃ nh

- [ ] CÃ i Ä‘áº·t Alembic
- [ ] Khá»Ÿi táº¡o Alembic
- [ ] Kiá»ƒm tra [alembic.ini](file:///d:/Freelancer/E-commerce/ECOMMERCE-BE-fast/alembic.ini) vÃ  [env.py](file:///d:/Freelancer/E-commerce/ECOMMERCE-BE-fast/alembic/env.py)
- [ ] Táº¡o migration Ä‘áº§u tiÃªn
- [ ] Review migration file
- [ ] Cháº¡y `alembic upgrade head`
- [ ] Kiá»ƒm tra database cÃ³ tables
- [ ] Test downgrade vÃ  upgrade

**Sau khi hoÃ n thÃ nh, báº¡n Ä‘Ã£ sáºµn sÃ ng dÃ¹ng Alembic!** ğŸ‰
