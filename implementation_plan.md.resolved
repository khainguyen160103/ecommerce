# Káº¿ hoáº¡ch: Luá»“ng Cart â†’ Checkout â†’ Payment

## Tá»•ng quan

Hiá»‡n táº¡i cart page Ä‘Ã£ cÃ³ (`/cart`) nhÆ°ng khi nháº¥n "Mua HÃ ng" thÃ¬ táº¡o order luÃ´n vÃ  redirect sang profile/orders â€” **chÆ°a cÃ³ trang Checkout** Ä‘á»ƒ ngÆ°á»i dÃ¹ng xÃ¡c nháº­n Ä‘á»‹a chá»‰, chá»n phÆ°Æ¡ng thá»©c thanh toÃ¡n. Cáº§n thÃªm 2 trang má»›i vÃ  tÃ­ch há»£p payment gateway (VNPay hoáº·c Stripe).

**Luá»“ng má»›i:**
```
/cart  â†’  /checkout  â†’  [Payment Gateway]  â†’  /payment/result?status=success|failed
```

---

## SÆ¡ Ä‘á»“ luá»“ng

```mermaid
sequenceDiagram
    participant User
    participant FE
    participant BE
    participant PayGW as Payment Gateway

    User->>FE: Nháº¥n "Mua HÃ ng" á»Ÿ Cart
    FE->>BE: POST /orders/ (táº¡o order vá»›i status=PENDING)
    BE-->>FE: { order_id, total_amount, ... }
    FE->>FE: Redirect â†’ /checkout?orderId=xxx
    User->>FE: Chá»n Ä‘á»‹a chá»‰, phÆ°Æ¡ng thá»©c thanh toÃ¡n â†’ XÃ¡c nháº­n
    FE->>BE: POST /payments/create { order_id, method }
    BE->>PayGW: Táº¡o payment session
    PayGW-->>BE: { payment_url, payment_id }
    BE-->>FE: { payment_url }
    FE->>User: Redirect â†’ payment_url (trang Gateway)
    User->>PayGW: Thá»±c hiá»‡n thanh toÃ¡n
    PayGW->>BE: Webhook POST /payments/webhook { payment_id, status }
    BE->>BE: Cáº­p nháº­t Order status â†’ PAID / FAILED
    PayGW->>FE: Redirect â†’ /payment/result?status=success&orderId=xxx
    FE->>User: Hiá»ƒn thá»‹ káº¿t quáº£ thanh toÃ¡n
```

---

## Lá»±a chá»n Payment Gateway

| Gateway | PhÃ¹ há»£p | Ghi chÃº |
|---|---|---|
| **VNPay** | ğŸ‡»ğŸ‡³ Viá»‡t Nam | Phá»• biáº¿n nháº¥t VN, há»— trá»£ ATM/QR/VISA |
| **Stripe** | Quá»‘c táº¿ | Dá»… tÃ­ch há»£p, sandbox tá»‘t, cÃ³ tháº» test |
| **MoMo** | ğŸ‡»ğŸ‡³ Viá»‡t Nam | VÃ­ Ä‘iá»‡n tá»­ phá»• biáº¿n |

> **Khuyáº¿n nghá»‹:** DÃ¹ng **VNPay** náº¿u target thá»‹ trÆ°á»ng VN, **Stripe** náº¿u muá»‘n tÃ­ch há»£p nhanh vÃ  test dá»….

---

## FRONTEND â€” CÃ¡c thay Ä‘á»•i cáº§n lÃ m

### 1. Trang Checkout `/checkout`

#### [NEW] `src/app/(shop)/checkout/page.tsx`
Trang xÃ¡c nháº­n Ä‘Æ¡n hÃ ng trÆ°á»›c khi thanh toÃ¡n, gá»“m:
- **Pháº§n Ä‘á»‹a chá»‰ giao hÃ ng**: hiá»ƒn thá»‹ Ä‘á»‹a chá»‰ hiá»‡n táº¡i tá»« user profile, cÃ³ nÃºt "Thay Ä‘á»•i"
- **Pháº§n tÃ³m táº¯t Ä‘Æ¡n hÃ ng**: danh sÃ¡ch sáº£n pháº©m, sá»‘ lÆ°á»£ng, giÃ¡ (láº¥y tá»« order vá»«a táº¡o)
- **Pháº§n chá»n phÆ°Æ¡ng thá»©c thanh toÃ¡n**: Radio group gá»“m:
  - ğŸ’³ Thanh toÃ¡n online (VNPay / Stripe)
  - ğŸ’µ Thanh toÃ¡n khi nháº­n hÃ ng (COD)
- **NÃºt "Äáº·t hÃ ng"**: gá»i API táº¡o payment session

**Dá»¯ liá»‡u truyá»n qua URL:** `?orderId=xxx` (láº¥y tá»« káº¿t quáº£ táº¡o order á»Ÿ cart page)

#### [NEW] `src/app/(shop)/payment/result/page.tsx`
Trang káº¿t quáº£ sau khi Gateway redirect vá»:
- Äá»c query params: `?status=success|failed&orderId=xxx`
- Náº¿u `success`: hiá»ƒn thá»‹ thÃ´ng bÃ¡o thÃ nh cÃ´ng, nÃºt "Xem Ä‘Æ¡n hÃ ng"
- Náº¿u `failed`: hiá»ƒn thá»‹ lá»—i, nÃºt "Thá»­ láº¡i" hoáº·c "Vá» trang chá»§"

---

### 2. Cáº­p nháº­t Cart Page

#### [MODIFY] `src/app/(shop)/cart/page.tsx`
Thay Ä‘á»•i hÃ m [handleCheckout](file:///d:/Freelancer/E-commerce/fe-ecommerce/src/app/%28shop%29/cart/page.tsx#75-106):
```diff
- createOrder(undefined, {
-   onSuccess: (data) => {
-     router.push(`/profile/order/${data.id}`)
-   }
- })
+ createOrder(undefined, {
+   onSuccess: (data) => {
+     // KhÃ´ng redirect sang order ngay, mÃ  sang trang checkout
+     router.push(`/checkout?orderId=${data.id}`)
+   }
+ })
```

---

### 3. API Request Layer

#### [NEW] `src/requests/payment.ts`
```typescript
// POST /payments/create â†’ tráº£ vá» { payment_url }
export const createPayment = async (data: { order_id: string; method: string }) => { ... }

// GET /payments/{payment_id} â†’ kiá»ƒm tra tráº¡ng thÃ¡i
export const getPaymentStatus = async (paymentId: string) => { ... }
```

#### [MODIFY] [src/requests/endpoint.ts](file:///d:/Freelancer/E-commerce/fe-ecommerce/src/requests/endpoint.ts)
ThÃªm PAYMENT endpoints:
```typescript
PAYMENT: {
    CREATE: 'payments/create',
    GET_BY_ID: (id) => `payments/${id}`,
    WEBHOOK: 'payments/webhook',
}
```

---

### 4. Custom Hook

#### [NEW] `src/hook/usePayment.ts`
```typescript
export const usePayment = () => {
  // useMutation: createPayment â†’ redirect Ä‘áº¿n payment_url
  const useCreatePayment = () => { ... }
  // useQuery: láº¥y tráº¡ng thÃ¡i payment (dÃ¹ng á»Ÿ result page)
  const useGetPaymentStatus = (paymentId: string) => { ... }
  return { useCreatePayment, useGetPaymentStatus }
}
```

---

### 5. Type Definitions

#### [MODIFY] [src/types/index.ts](file:///d:/Freelancer/E-commerce/fe-ecommerce/src/types/index.ts)
ThÃªm:
```typescript
export type PaymentMethod = 'VNPAY' | 'STRIPE' | 'COD'
export type PaymentStatus = 'PENDING' | 'PAID' | 'FAILED' | 'REFUNDED'
```

---

## BACKEND â€” CÃ¡c thay Ä‘á»•i cáº§n lÃ m

> Backend hiá»‡n dÃ¹ng **FastAPI** (dá»±a trÃªn conversation trÆ°á»›c). Cáº§n thÃªm má»™t payment service module.

### 1. Payment Model / Table

#### [NEW] `payment` table (Alembic migration)
```
id          UUID (PK)
order_id    UUID (FK â†’ orders)
method      Enum: VNPAY | STRIPE | COD
status      Enum: PENDING | PAID | FAILED | REFUNDED
amount      Decimal
gateway_ref VARCHAR   -- transaction ID tá»« gateway
created_at  DateTime
updated_at  DateTime
```

---

### 2. Payment Endpoints

#### [NEW] `POST /api/payments/create`
- Nháº­n: `{ order_id, method }`
- Kiá»ƒm tra order thuá»™c vá» user Ä‘ang login
- Náº¿u method = COD: cáº­p nháº­t order status â†’ CONFIRMED, tráº£ vá» success
- Náº¿u method = VNPAY/STRIPE: gá»i SDK táº¡o payment session, tráº£ vá» `{ payment_url, payment_id }`

#### [NEW] `GET /api/payments/{payment_id}`
- Tráº£ vá» tráº¡ng thÃ¡i payment hiá»‡n táº¡i

#### [NEW] `POST /api/payments/webhook`
- Endpoint **khÃ´ng cáº§n auth** nhÆ°ng cáº§n **verify signature** tá»« Gateway
- Nháº­n callback tá»« VNPay/Stripe
- Cáº­p nháº­t payment status trong DB
- Gá»i service cáº­p nháº­t order status tÆ°Æ¡ng á»©ng

---

### 3. Cáº­p nháº­t Order

#### [MODIFY] Order status flow
```
PENDING â†’ CONFIRMED (sau khi thanh toÃ¡n thÃ nh cÃ´ng hoáº·c COD)
PENDING â†’ FAILED (náº¿u thanh toÃ¡n tháº¥t báº¡i)
CONFIRMED â†’ SHIPPED â†’ DELIVERED
CONFIRMED â†’ CANCELLED
```

---

### 4. Báº£o máº­t Webhook

> [!IMPORTANT]
> Webhook tá»« Gateway pháº£i Ä‘Æ°á»£c **verify chá»¯ kÃ½ (signature)** Ä‘á»ƒ trÃ¡nh giáº£ máº¡o.
> - **VNPay**: verify `vnp_SecureHash` báº±ng HMAC-SHA512
> - **Stripe**: verify `Stripe-Signature` header báº±ng `stripe.webhooks.construct_event()`

---

### 5. Biáº¿n mÃ´i trÆ°á»ng cáº§n thÃªm

```env
# VNPay
VNPAY_TMN_CODE=your_tmn_code
VNPAY_HASH_SECRET=your_hash_secret
VNPAY_URL=https://sandbox.vnpayment.vn/paymentv2/vpcpay.html
VNPAY_RETURN_URL=http://localhost:3000/payment/result

# Stripe (náº¿u dÃ¹ng)
STRIPE_SECRET_KEY=sk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
STRIPE_SUCCESS_URL=http://localhost:3000/payment/result?status=success
STRIPE_CANCEL_URL=http://localhost:3000/payment/result?status=failed
```

---

## TÃ³m táº¯t file cáº§n táº¡o/sá»­a

### Frontend
| File | HÃ nh Ä‘á»™ng |
|---|---|
| `src/app/(shop)/checkout/page.tsx` | ğŸ†• Táº¡o má»›i |
| `src/app/(shop)/payment/result/page.tsx` | ğŸ†• Táº¡o má»›i |
| `src/requests/payment.ts` | ğŸ†• Táº¡o má»›i |
| `src/hook/usePayment.ts` | ğŸ†• Táº¡o má»›i |
| [src/requests/endpoint.ts](file:///d:/Freelancer/E-commerce/fe-ecommerce/src/requests/endpoint.ts) | âœï¸ Sá»­a - thÃªm PAYMENT endpoints |
| `src/app/(shop)/cart/page.tsx` | âœï¸ Sá»­a - redirect sang /checkout |

### Backend
| File/Module | HÃ nh Ä‘á»™ng |
|---|---|
| `payment` model + migration | ğŸ†• Táº¡o má»›i |
| `payments/router.py` | ğŸ†• Táº¡o má»›i |
| `payments/service.py` | ğŸ†• Táº¡o má»›i |
| `payments/schemas.py` | ğŸ†• Táº¡o má»›i |
| Order status logic | âœï¸ Sá»­a |
| `.env` | âœï¸ Sá»­a - thÃªm biáº¿n Gateway |

---

## CÃ¢u há»i cáº§n xÃ¡c nháº­n trÆ°á»›c khi code

1. **Báº¡n muá»‘n dÃ¹ng gateway nÃ o?** VNPay (phá»• biáº¿n VN) hay Stripe (dá»… test vá»›i sandbox)?
2. **COD (thanh toÃ¡n khi nháº­n hÃ ng)** cÃ³ cáº§n khÃ´ng?
3. **Äá»‹a chá»‰ giao hÃ ng** â€” user profile hiá»‡n cÃ³ lÆ°u Ä‘á»‹a chá»‰ chÆ°a, hay cáº§n ngÆ°á»i dÃ¹ng nháº­p táº¡i trang checkout?
